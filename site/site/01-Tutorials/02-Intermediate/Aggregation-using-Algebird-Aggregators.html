<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
  <meta http-equiv="Content-Style-Type" content="text/css"></meta>
  <meta name="generator" content="pandoc"></meta>
  <title>Aggregation using Algebird Aggregators</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="http://localhost:8000/_src/css/bootstrap.min.css" type="text/css"></link>
  <link rel="stylesheet" href="http://localhost:8000/_src/css/custom.css" type="text/css"></link>
  <style type="text/css">
    table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
      margin: 0; padding: 0; vertical-align: baseline; border: none; }
    table.sourceCode { width: 100%; line-height: 100%; }
    td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
    td.sourceCode { padding-left: 5px; }
    code > span.kw { color: #007020; font-weight: bold; }
    code > span.dt { color: #902000; }
    code > span.dv { color: #40a070; }
    code > span.bn { color: #40a070; }
    code > span.fl { color: #40a070; }
    code > span.ch { color: #4070a0; }
    code > span.st { color: #4070a0; }
    code > span.co { color: #60a0b0; font-style: italic; }
    code > span.ot { color: #007020; }
    code > span.al { color: #ff0000; font-weight: bold; }
    code > span.fu { color: #06287e; }
    code > span.er { color: #ff0000; font-weight: bold; }
  </style>
</head>
<body>

<div class="row">
    <div class="container">
        <div class="col-xs-4">
            <img id="logo" src="http://localhost:8000//_src/scalding.png">
        </div>
    </div>
</div>

<div class="container">
<div class="row">

<div class="col-xs-3" role="navigation" id="nav-left">
    
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/.Foo.md.html">.Foo.md</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/11.html"></a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/Home.html">Home</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/_Sidebar.html">_Sidebar</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/hello.html">hello</a>
    </li>
    </ul>
    Tutorials > Beginner
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/01-Beginner/01-Getting-Started.html">Getting Started</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/01-Beginner/02-Alice-in-Wonderland.html">Alice in Wonderland</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/01-Beginner/03-Intro-to-Scalding-Jobs.html">Intro to Scalding Jobs</a>
    </li>
    </ul>
    Tutorials > Intermediate
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/02-Intermediate/Aggregation-using-Algebird-Aggregators.html">Aggregation using Algebird Aggregators</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/02-Intermediate/SQL-to-Scalding.html">SQL to Scalding</a>
    </li>
    </ul>
    Tutorials > Advanced
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/03-Advanced/Building-bigger-platforms-with-scalding.html">Building bigger platforms with scalding</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/03-Advanced/Introduction-to-Matrix-Library.html">Introduction to Matrix Library</a>
    </li>
    </ul>
    Reference
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/02-Reference/API-Reference.html">API Reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Calling-Scalding-from-Inside-Your-Application.html">Calling Scalding from Inside Your Application</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Common-Exceptions-and-Possible-Reasons.html">Common Exceptions and Possible Reasons</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Frequently-asked-questions.html">Frequently asked questions</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Matrix-API-Reference.html">Matrix API Reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Pig-to-Scalding.html">Pig to Scalding</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/REPL-Reference.html">REPL Reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Rosetta-Code.html">Rosetta Code</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scald.rb.html">Scald.rb</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-Commons.html">Scalding Commons</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-HBase.html">Scalding HBase</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-REPL.html">Scalding REPL</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-Sources.html">Scalding Sources</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Type-safe-api-reference.html">Type safe api reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Using-scalding-with-other-versions-of-scala.html">Using scalding with other versions of scala</a>
    </li>
    </ul>
    Reference > Fields API (Deprecated)
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/02-Reference/01-Fields-API-(Deprecated)/Fields-API:-reduce-functions-of-GroupBuilder.html">Fields API: reduce functions of GroupBuilder</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/01-Fields-API-(Deprecated)/Fields-based-API-Reference.html">Fields based API Reference</a>
    </li>
    </ul>
    Other
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/03-Other/Comparison-to-Scrunch-and-Scoobi.html">Comparison to Scrunch and Scoobi</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Field-rules.html">Field rules</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Powered-By.html">Powered By</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Run-in-Intellij-IDEA.html">Run in Intellij IDEA</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scala-and-sbt-for-Homebrew-users.html">Scala and sbt for Homebrew users</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scala-and-sbt-for-MacPorts-users.html">Scala and sbt for MacPorts users</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scalding-on-amazon-elastic-mapreduce.html">Scalding on amazon elastic mapreduce</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scalding-with-CDH3U2-in-a-Maven-project.html">Scalding with CDH3U2 in a Maven project</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Upgrading-to-0.9.0.html">Upgrading to 0.9.0</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Using-the-distributed-cache.html">Using the distributed cache</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Why-pack-unpack-and-not--toList[].html">Why pack unpack and not  toList[]</a>
    </li>
    </ul>
</div>

<div class="col-xs-0 col-md-1"></div>

<div class="col-xs-9 col-md-8 text-body">

<div id="header">
<h1 class="title">Aggregation using Algebird Aggregators</h1>
</div>
<div id="TOC">
<ul>
<li><a href="#examples">Examples</a></li>
</ul>
</div>
<p>For this tutorial, you need to be using Algebird 0.7.2, 0.8.2 or 0.9 or later. You may need to update your build file (prefer 0.7.2 if you are on scalding 0.11 or scalding 0.12). Scalding 0.13+ comes with algebird 0.9 already.</p>
<p>Aggregators enable creation of reusable and composable aggregation functions. There are three main functions on Aggregator trait.</p>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> Aggregator[-A, B, +C]  {
  <span class="co">/**</span>
<span class="co">   * Transform the input before the reduction.</span>
<span class="co">   */</span>
  <span class="kw">def</span> <span class="fu">prepare</span>(input: A): B
   <span class="co">/**</span>
<span class="co">   * Combine two values to produce a new value.</span>
<span class="co">   */</span>
  <span class="kw">def</span> <span class="fu">reduce</span>(l: B, r: B): B
  <span class="co">/**</span>
<span class="co">   * Transform the output of the reduction.</span>
<span class="co">   */</span>
  <span class="kw">def</span> <span class="fu">present</span>(reduction: B): C
}</code></pre>
<h3 id="examples">Examples</h3>
<p>In this section we will use the data below to show SQL aggregate functions and how to build similar aggregate functions in Scalding. You can run these in the scalding repo by typing: <code>./sbt "scalding-repl/run --local"</code> and then use the <code>.dump</code> method to print results (or .get on <code>ValuePipe</code>s).</p>
<table class="table">
<thead>
<tr class="header">
<th align="center">OrderID</th>
<th align="center">OrderDate</th>
<th align="center">OrderPrice</th>
<th align="center">OrderQuantity</th>
<th align="center">CustomerName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">12/22/2005</td>
<td align="center">160</td>
<td align="center">2</td>
<td align="center">Smith</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">08/10/2005</td>
<td align="center">190</td>
<td align="center">2</td>
<td align="center">Johnson</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">07/13/2005</td>
<td align="center">500</td>
<td align="center">5</td>
<td align="center">Baldwin</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">07/15/2005</td>
<td align="center">420</td>
<td align="center">2</td>
<td align="center">Smith</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">12/22/2005</td>
<td align="center">1000</td>
<td align="center">4</td>
<td align="center">Wood</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">10/2/2005</td>
<td align="center">820</td>
<td align="center">4</td>
<td align="center">Smith</td>
</tr>
<tr class="odd">
<td align="center">7</td>
<td align="center">11/03/2005</td>
<td align="center">2000</td>
<td align="center">2</td>
<td align="center">Baldwin</td>
</tr>
</tbody>
</table>
<pre class="sourceCode scala"><code class="sourceCode scala"> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Order</span>(orderId: Int, orderDate: String, orderPrice: Long, orderQuantity: Long,
                  customerName: String)

 <span class="kw">val</span> orders = List(
    <span class="fu">Order</span>(<span class="dv">1</span>, <span class="st">"12/22/2005"</span>, <span class="dv">160</span>, <span class="dv">2</span>, <span class="st">"Smith"</span>),
    <span class="fu">Order</span>(<span class="dv">2</span>, <span class="st">"08/10/2005"</span>, <span class="dv">190</span>, <span class="dv">2</span>, <span class="st">"Johnson"</span>),
    <span class="fu">Order</span>(<span class="dv">3</span>, <span class="st">"07/13/2005"</span>, <span class="dv">500</span>, <span class="dv">5</span>, <span class="st">"Baldwin"</span>),
    <span class="fu">Order</span>(<span class="dv">4</span>, <span class="st">"07/15/2005"</span>, <span class="dv">420</span>, <span class="dv">2</span>, <span class="st">"Smith"</span>),
    <span class="fu">Order</span>(<span class="dv">5</span>, <span class="st">"12/22/2005"</span>, <span class="dv">1000</span>, <span class="dv">4</span>, <span class="st">"Wood"</span>),
    <span class="fu">Order</span>(<span class="dv">6</span>, <span class="st">"10/2/2005"</span>, <span class="dv">820</span>, <span class="dv">4</span>, <span class="st">"Smith"</span>),
    <span class="fu">Order</span>(<span class="dv">7</span>, <span class="st">"11/03/2005"</span>, <span class="dv">2000</span>, <span class="dv">2</span>, <span class="st">"Baldwin"</span>))</code></pre>
<h4 id="count">Count</h4>
<p>The SQL COUNT function returns the number of rows in a table satisfying the criteria specified in the WHERE clause.</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> <span class="fu">COUNT</span> (*) <span class="kw">FROM</span> Orders
<span class="kw">WHERE</span> CustomerName = <span class="st">'Smith'</span></code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">count</span>

TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">aggregate</span>(<span class="fu">count</span>(_.<span class="fu">customerName</span> == <span class="st">"Smith"</span>))</code></pre>
<pre><code>Output: 3</code></pre>
<p>If you don’t specify a WHERE clause when using COUNT, your statement will simply return the total number of rows in the table</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> <span class="fu">COUNT</span>(*) <span class="kw">FROM</span> Orders</code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">size</span>

TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">aggregate</span>(size)</code></pre>
<pre><code>Output: 7</code></pre>
<p>You can also use aggregate functions with <code>Group By</code>.</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">Select</span> CustomerName, <span class="fu">Count</span>(CustomerName)
<span class="kw">From</span> Orders
<span class="kw">Group</span> <span class="kw">by</span> CustomerName</code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">size</span>

TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(size)

Output:
(Baldwin,<span class="dv">2</span>)
(Johnson,<span class="dv">1</span>)
(Smith,<span class="dv">3</span>)
(Wood,<span class="dv">1</span>)</code></pre>
<h4 id="sum">Sum</h4>
<p>The SQL SUM function is used to return the sum of an expression in a SELECT statement</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> <span class="fu">SUM</span>(OrderQuantity)
<span class="kw">FROM</span> Orders
<span class="kw">GROUP</span> <span class="kw">BY</span> CustomerName</code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> Aggregator.{ prepareMonoid => sumAfter }

TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(<span class="fu">sumAfter</span>(_.<span class="fu">orderQuantity</span>))

Output:
(Baldwin,<span class="dv">7</span>)
(Johnson,<span class="dv">2</span>)
(Smith,<span class="dv">8</span>)
(Wood,<span class="dv">4</span>)</code></pre>
<h4 id="max">Max</h4>
<p>The SQL MAX function retrieves the maximum numeric value from a column.</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> CustomerName, <span class="fu">MAX</span>(OrderQuantity)
<span class="kw">FROM</span> <span class="kw">Order</span>
<span class="kw">GROUP</span> <span class="kw">By</span> CustomerName</code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">max</span>

<span class="kw">val</span> maxOp = Aggregator.<span class="fu">max</span>[Long].<span class="fu">composePrepare</span> { o: Order => o.<span class="fu">orderQuantity</span> }

 TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(maxOp)

Output:
(Baldwin,<span class="dv">5</span>)
(Johnson,<span class="dv">2</span>)
(Smith,<span class="dv">4</span>)
(Wood,<span class="dv">4</span>)</code></pre>
<h4 id="min">Min</h4>
<p>The SQL MIN function selects the smallest number from a column.</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> CustomerName, <span class="fu">MIN</span>(OrderQuantity)
<span class="kw">FROM</span> <span class="kw">Order</span>
<span class="kw">GROUP</span> <span class="kw">By</span> CustomerName</code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">minBy</span>

 <span class="co">// Rather than using composePrepare, we could also use minBy with andThenPresent:</span>
 <span class="kw">val</span> minOp = minBy[Order, Long](_.<span class="fu">orderQuantity</span>)
      .<span class="fu">andThenPresent</span>(_.<span class="fu">orderQuantity</span>)

 TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(minOp)</code></pre>
<h4 id="avg">AVG</h4>
<p>The SQL AVG function calculates average value of a numeric column.</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> CustomerName, <span class="fu">AVG</span>(OrderQuantity)
<span class="kw">FROM</span> <span class="kw">Order</span>
<span class="kw">GROUP</span> <span class="kw">BY</span> CustomerName</code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">_</span>

 <span class="kw">val</span> avg = AveragedValue.<span class="fu">aggregator</span>.<span class="fu">composePrepare</span>[Order](_.<span class="fu">orderQuantity</span>)

 TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(avg)

Output:
(Baldwin,<span class="fl">3.5</span>)
(Johnson,<span class="fl">2.0</span>)
(Smith,<span class="fl">2.66</span>)
(Wood,<span class="fl">4.0</span>)</code></pre>
<h4 id="distinct">Distinct</h4>
<p>The SQL DISTINCT function selects distinct values from a column. In scalding we use a probabilistic data structure called <a href="https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/HyperLogLog.scala">HyperLogLog</a> to calculate distinct values.</p>
<pre class="sourceCode sql"><code class="sourceCode sql">SQL:
<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> CustomerName
<span class="kw">FROM</span> <span class="kw">Order</span></code></pre>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="co">//Scalding:</span>
<span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">HyperLogLogAggregator</span>

<span class="kw">val</span> unique = HyperLogLogAggregator
       <span class="co">//HLL Error is about 1.04/sqrt(2^{bits}), so you want something like 12 bits for 1% error</span>
      <span class="co">// which means each HLLInstance is about 2^{12} = 4kb per instance.</span>
      .<span class="fu">sizeAggregator</span>(bits = <span class="dv">12</span>)
       <span class="co">//convert customer names to UTF-8 encoded bytes as HyperLogLog expects a byte array.</span>
      .<span class="fu">composePrepare</span>[Order](_.<span class="fu">customerName</span>.<span class="fu">getBytes</span>(<span class="st">"UTF-8"</span>))

TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">aggregate</span>(unique)

Output:
<span class="fl">4.0</span></code></pre>
<h4 id="top-k">Top K</h4>
<pre class="sourceCode scala"><code class="sourceCode scala"> <span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">sortedReverseTake</span>

 <span class="kw">val</span> topK = sortedReverseTake[Long](<span class="dv">2</span>)
             .<span class="fu">composePrepare</span>[Order](_.<span class="fu">orderQuantity</span>)

 TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(topK)

Output:
(Baldwin,List(<span class="dv">5</span>, <span class="dv">2</span>))
(Johnson,List(<span class="dv">2</span>))
(Smith,List(<span class="dv">4</span>, <span class="dv">2</span>))
(Wood,List(<span class="dv">4</span>))</code></pre>
<h4 id="composing-aggregators">Composing Aggregators</h4>
<p>Aggregators can be composed to perform multiple aggregation in one pass.</p>
<pre class="sourceCode scala"><code class="sourceCode scala">  <span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">_</span>

  <span class="kw">val</span> maxOp = maxBy[Order, Long](_.<span class="fu">orderQuantity</span>).<span class="fu">andThenPresent</span>(_.<span class="fu">orderQuantity</span>)
  <span class="kw">val</span> minOp = minBy[Order, Long](_.<span class="fu">orderPrice</span>).<span class="fu">andThenPresent</span>(_.<span class="fu">orderPrice</span>)
  <span class="kw">val</span> combinedMetric = maxOp.<span class="fu">join</span>(minOp)

  TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(combinedMetric)

Output:
(Baldwin,(<span class="dv">5</span>,<span class="dv">500</span>))
(Johnson,(<span class="dv">2</span>,<span class="dv">190</span>))
(Smith,(<span class="dv">4</span>,<span class="dv">160</span>))
(Wood,(<span class="dv">4</span>,<span class="dv">1000</span>))</code></pre>
<p>composition can also be used to combine two or more aggregators to derive a new aggregate function.</p>
<pre class="sourceCode scala"><code class="sourceCode scala"> <span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">_</span>
 <span class="kw">import</span> Aggregator.{ prepareMonoid => sumAfter }

 <span class="kw">val</span> sumAggregator = sumAfter[Order, Long](_.<span class="fu">orderQuantity</span>)
 <span class="kw">val</span> sizeAggregator = size
 <span class="co">/*</span>
<span class="co">   Use more efficient `AveragedValue.aggregator` for AVG calculation. This example</span>
<span class="co">   is only to show how to combine two aggregators.</span>
<span class="co">  */</span>
 <span class="kw">val</span> avg = sumAggregator.<span class="fu">join</span>(sizeAggregator)
            .<span class="fu">andThenPresent</span>{ <span class="kw">case</span> (sum, count) => sum.<span class="fu">toDouble</span> / count.<span class="fu">toDouble</span> }

 TypedPipe.<span class="fu">from</span>(orders)
      .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
      .<span class="fu">aggregate</span>(avg)

Output:
(Baldwin,<span class="fl">3.5</span>)
(Johnson,<span class="fl">2.0</span>)
(Smith,<span class="fl">2.66</span>)
(Wood,<span class="fl">4.0</span>)</code></pre>
<p>you can join up to 22 <code>aggregators</code> by using <code>GeneratedTupleAggregator</code>. Example below show calculating Max, Min, Sum, Count, Mean and Standard Deviation in one pass by joining different aggregators.</p>
<pre class="sourceCode scala"><code class="sourceCode scala">   <span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.<span class="fu">Aggregator</span>.<span class="fu">_</span>
   <span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">algebird</span>.{GeneratedTupleAggregator, MomentsAggregator, Moments }
   <span class="kw">import</span> Aggregator.{ prepareMonoid => sumAfter }

   <span class="kw">val</span> maxOp = maxBy[Order, Long](_.<span class="fu">orderPrice</span>)
   <span class="kw">val</span> minOp = minBy[Order, Long](_.<span class="fu">orderPrice</span>)
   <span class="kw">val</span> sum = sumAfter[Order, Long](_.<span class="fu">orderPrice</span>)
   <span class="kw">val</span> moments = Moments.<span class="fu">aggregator</span>.<span class="fu">composePrepare</span>[Order](_.<span class="fu">orderPrice</span>.<span class="fu">toDouble</span>)

   <span class="kw">val</span> multiAggregator = GeneratedTupleAggregator
      .<span class="fu">from4</span>(maxOp, minOp, sum, moments)
      .<span class="fu">andThenPresent</span> {
        <span class="kw">case</span> (mmax, mmin, ssum, moment) =>
              (mmax.<span class="fu">orderPrice</span>, mmin.<span class="fu">orderPrice</span>, ssum, moment.<span class="fu">count</span>, moment.<span class="fu">mean</span>, moment.<span class="fu">stddev</span>)
      }

    TypedPipe.<span class="fu">from</span>(orders)
        .<span class="fu">groupBy</span>(_.<span class="fu">customerName</span>)
        .<span class="fu">aggregate</span>(multiAggregator)

Output:
(Baldwin,(<span class="dv">2000</span>,<span class="dv">500</span>,<span class="dv">2500</span>,<span class="dv">2</span>,<span class="fl">1250.0</span>,<span class="fl">750.0</span>))
(Johnson,(<span class="dv">190</span>,<span class="dv">190</span>,<span class="dv">190</span>,<span class="dv">1</span>,<span class="fl">190.0</span>,<span class="fl">0.0</span>))
(Smith,(<span class="dv">820</span>,<span class="dv">160</span>,<span class="dv">1400</span>,<span class="dv">3</span>,<span class="fl">466.66</span>,<span class="fl">271.46</span>))
(Wood,(<span class="dv">1000</span>,<span class="dv">1000</span>,<span class="dv">1000</span>,<span class="dv">1</span>,<span class="fl">1000.0</span>,<span class="fl">0.0</span>))</code></pre>

</div>

</div>
</div>

</body>
</html>
