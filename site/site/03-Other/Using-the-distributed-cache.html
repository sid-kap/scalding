<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
  <meta http-equiv="Content-Style-Type" content="text/css"></meta>
  <meta name="generator" content="pandoc"></meta>
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="http://localhost:8000/_src/css/bootstrap.min.css" type="text/css"></link>
  <link rel="stylesheet" href="http://localhost:8000/_src/css/custom.css" type="text/css"></link>
  <style type="text/css">
    table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
      margin: 0; padding: 0; vertical-align: baseline; border: none; }
    table.sourceCode { width: 100%; line-height: 100%; }
    td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
    td.sourceCode { padding-left: 5px; }
    code > span.kw { color: #007020; font-weight: bold; }
    code > span.dt { color: #902000; }
    code > span.dv { color: #40a070; }
    code > span.bn { color: #40a070; }
    code > span.fl { color: #40a070; }
    code > span.ch { color: #4070a0; }
    code > span.st { color: #4070a0; }
    code > span.co { color: #60a0b0; font-style: italic; }
    code > span.ot { color: #007020; }
    code > span.al { color: #ff0000; font-weight: bold; }
    code > span.fu { color: #06287e; }
    code > span.er { color: #ff0000; font-weight: bold; }
  </style>
</head>
<body>

<div class="row">
    <div class="container">
        <div class="col-xs-4">
            <img id="logo" src="http://localhost:8000//_src/scalding.png">
        </div>
    </div>
</div>

<div class="container">
<div class="row">

<div class="col-xs-3" role="navigation" id="nav-left">
    
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/.Foo.md.html">.Foo.md</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/11.html"></a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/Home.html">Home</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/_Sidebar.html">_Sidebar</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/hello.html">hello</a>
    </li>
    </ul>
    Tutorials > Beginner
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/01-Beginner/01-Getting-Started.html">Getting Started</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/01-Beginner/02-Alice-in-Wonderland.html">Alice in Wonderland</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/01-Beginner/03-Intro-to-Scalding-Jobs.html">Intro to Scalding Jobs</a>
    </li>
    </ul>
    Tutorials > Intermediate
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/02-Intermediate/Aggregation-using-Algebird-Aggregators.html">Aggregation using Algebird Aggregators</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/02-Intermediate/SQL-to-Scalding.html">SQL to Scalding</a>
    </li>
    </ul>
    Tutorials > Advanced
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/03-Advanced/Building-bigger-platforms-with-scalding.html">Building bigger platforms with scalding</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/01-Tutorials/03-Advanced/Introduction-to-Matrix-Library.html">Introduction to Matrix Library</a>
    </li>
    </ul>
    Reference
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/02-Reference/API-Reference.html">API Reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Calling-Scalding-from-Inside-Your-Application.html">Calling Scalding from Inside Your Application</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Common-Exceptions-and-Possible-Reasons.html">Common Exceptions and Possible Reasons</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Frequently-asked-questions.html">Frequently asked questions</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Matrix-API-Reference.html">Matrix API Reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Pig-to-Scalding.html">Pig to Scalding</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/REPL-Reference.html">REPL Reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Rosetta-Code.html">Rosetta Code</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scald.rb.html">Scald.rb</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-Commons.html">Scalding Commons</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-HBase.html">Scalding HBase</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-REPL.html">Scalding REPL</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Scalding-Sources.html">Scalding Sources</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Type-safe-api-reference.html">Type safe api reference</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/Using-scalding-with-other-versions-of-scala.html">Using scalding with other versions of scala</a>
    </li>
    </ul>
    Reference > Fields API (Deprecated)
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/02-Reference/01-Fields-API-(Deprecated)/Fields-API:-reduce-functions-of-GroupBuilder.html">Fields API: reduce functions of GroupBuilder</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/02-Reference/01-Fields-API-(Deprecated)/Fields-based-API-Reference.html">Fields based API Reference</a>
    </li>
    </ul>
    Other
    <ul class="nav nav-pills nav-stacked"><li role="presentation"><a href="http://localhost:8000/site/03-Other/Comparison-to-Scrunch-and-Scoobi.html">Comparison to Scrunch and Scoobi</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Field-rules.html">Field rules</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Powered-By.html">Powered By</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Run-in-Intellij-IDEA.html">Run in Intellij IDEA</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scala-and-sbt-for-Homebrew-users.html">Scala and sbt for Homebrew users</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scala-and-sbt-for-MacPorts-users.html">Scala and sbt for MacPorts users</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scalding-on-amazon-elastic-mapreduce.html">Scalding on amazon elastic mapreduce</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Scalding-with-CDH3U2-in-a-Maven-project.html">Scalding with CDH3U2 in a Maven project</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Upgrading-to-0.9.0.html">Upgrading to 0.9.0</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Using-the-distributed-cache.html">Using the distributed cache</a>
    </li>
    <li role="presentation"><a href="http://localhost:8000/site/03-Other/Why-pack-unpack-and-not--toList[].html">Why pack unpack and not  toList[]</a>
    </li>
    </ul>
</div>

<div class="col-xs-9 text-body">

<p>The distributed cache is simply hadoop's method for allowing each node local access to a specific file. In the example, I am mapping ip addresses to geographical locations (country, city, etc.). The heavy lifting is done my Maxmind's geoip LookupService. LookupService requires random access to a local file, GeoLiteCity.dat, which defines a mapping from ip ranges to a location object.</p>
<p>The DistributedCacheFile object provides a simple API for dealing with registering files to be copied into the file cache at configuration time, and accessing them later during map/reduce time.</p>
<p>Firstly, we need to place the file in question on the hadoop file system. I used <a href="http://docs.aws.amazon.com/ElasticMapReduce/latest/DeveloperGuide/UsingEMR_s3distcp.html">s3distcp</a> to put a copy of GeoLiteCity.dat to hdfs://cache/GeoLiteCity.dat. If your copy is not on s3, you can use the normal distcp command.</p>
<p>So now GeoLiteCity.dat is distributed across the data nodes. So let now go to the scalding code.</p>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">import</span> com.<span class="fu">twitter</span>.<span class="fu">scalding</span>.<span class="fu">filecache</span>.<span class="fu">DistributedCacheFile</span>

<span class="kw">val</span> geoIPDataFile = <span class="fu">DistributedCacheFile</span>(<span class="st">"hdfs://path/to/maxmind.dat"</span>)</code></pre>
<p>This handles registering the file in the DistributedCache for us at configuration time, and will work in both local and hdfs modes (in local mode, it simply uses the local path and creates no symlinks).</p>
<p>Next, we need to be very careful about how we instantiate LookupService. Lookup service is not serializable, so we cannot be holding a reference when the job get serialized to the nodes. Also we don't want to be initializing it more than once per task attempt.</p>
<pre class="sourceCode scala"><code class="sourceCode scala"> @transient <span class="kw">private</span> <span class="kw">lazy</span> <span class="kw">val</span> lookupService =
 	<span class="kw">new</span> <span class="fu">LookupService</span>(geoIPDataFile.<span class="fu">path</span>, LookupService.<span class="fu">GEOIP_MEMORY_CACHE</span>)</code></pre>
<p>By making lookupService transient, we avoid serialization, but it means that it will be null when received by the nodes. Making it lazy ensures that the nodes will initalize it when needed. We use the auto-generated symlink path created by DistributedCacheFile. This does not require the jobConf as it will not be availible, when lookupService is lazily evaluated.</p>
<p>Lastly, we write a function to be used by our mappers to do the lookup. This is included for completeness:</p>
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">def</span> <span class="fu">getLocationInfo</span>(ip: String): (String, String, String, String, String, Int) = {
    <span class="kw">val</span> unknown = (<span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="st">""</span>, <span class="dv">0</span>)
    <span class="kw">if</span> (ip == <span class="st">""</span> || ip == <span class="kw">null</span>)
      <span class="kw">return</span> unknown
    <span class="kw">val</span> location = lookupService.<span class="fu">getLocation</span>(ip)
    <span class="kw">if</span> (location == <span class="kw">null</span>)
      <span class="kw">return</span> unknown
    (location.<span class="fu">countryName</span>,
     location.<span class="fu">countryCode</span>,
     location.<span class="fu">region</span>,
     location.<span class="fu">city</span>,
     location.<span class="fu">postalCode</span>,
     location.<span class="fu">metro_code</span>)
  }</code></pre>

</div>

</div>
</div>

</body>
</html>
